<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Roger's Annotatie Tool</title>
  <style>
  :root {
  --bg-color: #121212;
  --text-color: #ffe66d;
  --panel-bg: #1e1e1e;
  --highlight: #2a2a2a;
  --border-color: #444;
}

body.light {
  --bg-color: #ffffff;
  --text-color: #000000;
  --panel-bg: #f5f5f5;
  --highlight: #e6f0ff;
  --border-color: #ccc;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  font-family: Arial, sans-serif;
  margin: 0;
  display: flex;
  flex-direction: row; /* standaard: menu links */
}

/* üåó Menu rechts */
body.menu-right {
  flex-direction: row-reverse;
}

/* ‚úÖ Toggle buttons */
#themeToggle,
#menuPositionToggle {
  right: 10px;
  z-index: 999;
  padding: 0.5rem 1rem;
  background: var(--highlight);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.9rem;
}
#menuPositionToggle {
  top: 50px;
}
#themeToggle {
  top: 10px;
}

/* ‚úÖ Annotatie-zijbalk */
.annotations-panel {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: clamp(100px, 30%, 300px);
  background-color: var(--panel-bg);
  padding: 1rem;
  border-right: 2px solid var(--border-color);
  overflow-y: auto;
  box-sizing: border-box;
  z-index: 10;
}
body.menu-right .annotations-panel {
  left: auto;
  right: 0;
  border-right: none;
  border-left: 2px solid var(--border-color);
}

/* ‚úÖ Hoofdtekstgedeelte */
.text-content {
  width: 70%;
  padding: 1rem;
  line-height: 1.8;
  margin-left: clamp(3rem, 30vw, 25rem); /* ruimte maken voor de fixed panel */
}
body.menu-right .text-content {
  margin-left: 2rem;
  margin-right: 30%;
}


/* ‚úÖ Zinnen */
.text-content span {
  display: inline-block;
  margin-bottom: 0.5rem;
  outline: none;
  padding: 0.2rem;
}

.text-content span:focus {
  outline: none;
  background-color: #222; /* donkergrijze achtergrond */
  color: #ffea00; /* heldergeel voor goede leesbaarheid */
  box-shadow: 
    0 0 0 3px #1e90ff,        /* helderblauwe rand (dodgerblue) */
    0 0 12px 4px #00bfff;     /* lichtblauwe gloed (deepskyblue) */
  border-radius: 6px;
  padding: 0.3rem 0.5rem;
  transition: all 0.1s ease;
}



/* ‚úÖ Geannoteerde zinnen */
.annotated {
  color: black !important;
}

/* ‚úÖ Annotatieblok */
.annotation-item {
  background-color: var(--panel-bg);
  border: 1px solid var(--border-color);
  border-radius: 5px;
  margin-bottom: 1rem;
  padding: 0.5rem;
  color: black !important;
  word-break: break-word;
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
}

.annotation-item div {
  flex: 1 1 auto;
  min-width: 150px;
}

.annotation-item:focus {
  outline: 3px solid #ffd700; /* geel, goed zichtbaar op dark √©n light */
  outline-offset: 2px;
  background-color: var(--highlight); /* optioneel extra visuele cue */
}


/* ‚ùå Verwijderknop */
.delete-btn {
  position: absolute;
  top: 5px;
  right: 10px;
  background: none;
  border: none;
  color: transparent;
  font-size: 16px;
  cursor: pointer;
}

/* ‚úÖ Annotatie popup */
#annotationPopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--panel-bg);
  border: 2px solid var(--border-color);
  padding: 1rem;
  z-index: 1000;
  width: clamp(100px, 80%, 500px);
  height: 300px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
  color: var(--text-color);
}

#annotationPopup textarea {
  width: 95%;
  height: 240px;
  font-size: 1rem;
  margin-bottom: 0.5rem;
  background-color: var(--bg-color);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  padding: 0.5rem;
}

/* üé® Kleurkiezer */
#colorPicker {
  display: none;
  margin-top: 1rem;
}

.color-options {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.color-option {
  width: 50px;
  height: 50px;
  border: 2px solid var(--border-color);
  border-radius: 4px;
  cursor: pointer;
  outline: none;
}

.color-option:focus {
  outline: 3px solid #fff;
  outline-offset: 2px;
  box-shadow: 0 0 0 4px #0078d4; /* Blauw glow randje */
  border-color: #0078d4;         /* Zelfde kleur als je andere focus */
}

.screenReaderWrapper{
  position: relative;
  margin-top: 1rem;
  background: var(--highlight);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  border-radius: 5px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  width: 100%;
  box-sizing: border-box;
}

#speedControlWrapper {
  background: var(--highlight);
  color: var(--text-color);
  font-size: 0.9rem;
  width: 100%;
}

#speedControlWrapper label {
  display: block;
  margin-bottom: 0.4rem;
  font-weight: bold;
}

#speedSlider {
  width: 100%;
}

#volumeControlWrapper {
  margin-top: 1rem;
  background: var(--highlight);
  color: var(--text-color);
  font-size: 0.9rem;
  width: 100%;
}

#volumeControlWrapper label {
  display: block;
  margin-bottom: 0.4rem;
  font-weight: bold;
}

#volumeSlider {
  width: 100%;
}

.settings-panel {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 999;
  background: var(--highlight);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1rem;
  width: 220px;
  display: none;
}

.settings-panel button,
.settings-panel input,
.settings-panel label {
  display: block;
  margin-bottom: 1rem;
  width: 100%;
}

#textStyleWrapper {
  position: relative;
  margin-top: 1rem;
  background: var(--highlight);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  border-radius: 5px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  width: 100%;
  box-sizing: border-box;
}

#textStyleWrapper label {
  display: block;
  margin-top: 0.8rem;
  margin-bottom: 0.4rem;
  font-weight: bold;
}

#textStyleWrapper input[type="range"] {
  width: 100%;
}

#textStyleWrapper div {
  margin-top: 0.3rem;
}





  </style>
</head>
<body>

<!-- üåó Theme toggle -->
<div id="settingsPanel" class="settings-panel" style="display: none;">
    <!-- Toggle donker/licht -->
    <button id="themeToggle" aria-label="Toggle theme: Light or Dark">
      ‚òÄÔ∏è Licht / üåô Donker
    </button>
  
    <!-- Menu links/rechts -->
    <button id="menuPositionToggle" aria-label="Toggle annotation menu position: Left or Right">
      üìç Menu links/rechts
    </button>
    
    <!-- Spreeksnelheid slider -->
     <div class="screenReaderWrapper">
    <div id="speedControlWrapper">
      <label for="speedSlider">üîä Reading speed</label>
      <input 
        type="range"
        id="speedSlider"
        min="0.1"
        max="2"
        step="0.1"
        value="0.9"
        aria-label="Reading speed"
      >
      <div id="speedValue">Current: 0.9x</div>
    </div>
  
    <!-- Volume slider -->
    <div id="volumeControlWrapper">
      <label for="volumeSlider">üîà Volume</label>
      <input 
        type="range"
        id="volumeSlider"
        min="0"
        max="1"
        step="0.1"
        value="1"
        aria-label="Reading volume"
      >
      <div id="volumeValue">Current: 1.0</div>
    </div>
</div>
<!-- Tekstinstellingen -->
<div id="textStyleWrapper">
    <label for="fontSizeSlider">üî† Tekstgrootte</label>
    <input 
      type="range" 
      id="fontSizeSlider" 
      min="14" 
      max="30" 
      value="18"
      aria-label="Font size"
    >
    <div id="fontSizeValue">Current: 18px</div>
  
    <label for="fontWeightSlider">üÖ±Ô∏è Dikte van tekst</label>
    <input 
      type="range" 
      id="fontWeightSlider" 
      min="100" 
      max="900" 
      step="100" 
      value="400"
      aria-label="Font weight"
    >
    <div id="fontWeightValue">Current: 400</div>
  
    <label for="lineHeightSlider">üìè Regelafstand</label>
    <input 
      type="range" 
      id="lineHeightSlider" 
      min="1" 
      max="3" 
      step="0.1" 
      value="1.8"
      aria-label="Line height"
    >
    <div id="lineHeightValue">Current: 1.8</div>
  
    <label for="letterSpacingSlider">üî° Letterafstand</label>
    <input 
      type="range" 
      id="letterSpacingSlider" 
      min="0" 
      max="5" 
      step="0.1" 
      value="0"
      aria-label="Letter spacing"
    >
    <div id="letterSpacingValue">Current: 0</div>
    
  </div>
  
  </div>


  
  
  
  
  
  
  
  

<div class="annotations-panel" id="annotationsPanel">
  <h2>Annotaties</h2>
</div>

<div class="text-content">
  <span tabindex="0" id="s1">It is a melancholy object to those, who walk through this great town, or travel
    in the country, when they see the streets, the roads, and cabbin-doors crowded
    with beggars of the female sex, followed by three, four, or six children, all
    in rags, and importuning every passenger for an alms. These mothers, instead of
    being able to work for their honest livelihood, are forced to employ all their
    time in stroling to beg sustenance for their helpless infants who, as they grow
    up, either turn thieves for want of work, or leave their dear native country,
    to fight for the Pretender in Spain, or sell themselves to the Barbadoes.</span>
  <span tabindex="0" id="s2">I think it is agreed by all parties, that this prodigious number of children in
    the arms, or on the backs, or at the heels of their mothers, and frequently of
    their fathers, is in the present deplorable state of the kingdom, a very great
    additional grievance; and therefore whoever could find out a fair, cheap and
    easy method of making these children sound and useful members of the
    commonwealth, would deserve so well of the publick, as to have his statue set
    up for a preserver of the nation.</span>
  <span tabindex="0" id="s3">But my intention is very far from being confined to provide only for the
    children of professed beggars: it is of a much greater extent, and shall take
    in the whole number of infants at a certain age, who are born of parents in
    effect as little able to support them, as those who demand our charity in the
    streets.</span>
    <span tabindex="0" id="s4">As to my own part, having turned my thoughts for many years upon this
        important subject, and maturely weighed the several schemes of our projectors,
        I have always found them grossly mistaken in their computation. It is true, a
        child just dropt from its dam, may be supported by her milk, for a solar year,
        with little other nourishment: at most not above the value of two shillings,
        which the mother may certainly get, or the value in scraps, by her lawful
        occupation of begging; and it is exactly at one year old that I propose to
        provide for them in such a manner, as, instead of being a charge upon their
        parents, or the parish, or wanting food and raiment for the rest of their
        lives, they shall, on the contrary, contribute to the feeding, and partly to
        the clothing of many thousands.</span>
    <span tabindex="0" id="s5">There is likewise another great advantage in my scheme, that it will prevent
        those voluntary abortions, and that horrid practice of women murdering their
        bastard children, alas! too frequent among us, sacrificing the poor innocent
        babes, I doubt, more to avoid the expence than the shame, which would move
        tears and pity in the most savage and inhuman breast.</span>
    <span tabindex="0" id="s6">The number of souls in this kingdom being usually reckoned one million and a
        half, of these I calculate there may be about two hundred thousand couple,
        whose wives are breeders; from which number I subtract thirty thousand couple,
        who are able to maintain their own children, (although I apprehend there cannot
        be so many under the present distresses of the kingdom) but this being
        granted, there will remain a hundred and seventy thousand breeders. I again
        subtract fifty thousand, for those women who miscarry, or whose children die by
        accident or disease within the year. There only remain a hundred and twenty
        thousand children of poor parents annually born. The question therefore is, How
        this number shall be reared and provided for? which, as I have already said,
        under the present situation of affairs, is utterly impossible by all the
        methods hitherto proposed. For we can neither employ them in handicraft or
        agriculture; they neither build houses, (I mean in the country) nor cultivate
        land: they can very seldom pick up a livelihood by stealing till they arrive at
        six years old; except where they are of towardly parts, although I confess they
        learn the rudiments much earlier; during which time they can however be
        properly looked upon only as probationers; as I have been informed by a
        principal gentleman in the county of Cavan, who protested to me, that he never
        knew above one or two instances under the age of six, even in a part of the
        kingdom so renowned for the quickest proficiency in that art.</span>
    <span tabindex="0" id="s7">I am assured by our merchants, that a boy or a girl, before twelve years old,
        is no saleable commodity, and even when they come to this age, they will not
        yield above three pounds, or three pounds and half a crown at most, on the
        exchange; which cannot turn to account either to the parents or kingdom, the
        charge of nutriments and rags having been at least four times that value.</span>
    <span tabindex="0" id="s8">I shall now therefore humbly propose my own thoughts, which I hope will not be
        liable to the least objection.</span>
    <span tabindex="0" id="s9">I have been assured by a very knowing American of my acquaintance in London,
        that a young healthy child well nursed, is, at a year old, a most delicious
        nourishing and wholesome food, whether stewed, roasted, baked, or boiled; and I
        make no doubt that it will equally serve in a fricasee, or a ragoust.</span>
    <span tabindex="0" id="s10">I do therefore humbly offer it to publick consideration, that of the hundred
        and twenty thousand children, already computed, twenty thousand may be reserved
        for breed, whereof only one fourth part to be males; which is more than we
        allow to sheep, black cattle, or swine, and my reason is, that these children
        are seldom the fruits of marriage, a circumstance not much regarded by our
        savages, therefore, one male will be sufficient to serve four females. That the
        remaining hundred thousand may, at a year old, be offered in sale to the
        persons of quality and fortune, through the kingdom, always advising the mother
        to let them suck plentifully in the last month, so as to render them plump, and
        fat for a good table. A child will make two dishes at an entertainment for
        friends, and when the family dines alone, the fore or hind quarter will make a
        reasonable dish, and seasoned with a little pepper or salt, will be very good
        boiled on the fourth day, especially in winter.</span>
    

</div>

<!-- Popup -->
<div id="annotationPopup">
  <textarea id="annotationInput" placeholder="Typ je annotatie..."></textarea>
  <button id="saveBtn" aria-label="Annotatie opslaan">Opslaan</button>
  <button id="cancelBtn" aria-label="Annotatie annuleren">Annuleren</button>
  

  <div id="colorPicker">
    <p>Kies een kleur:</p>
    <div class="color-options">
      <div class="color-option" style="background-color: #fff7b2;" data-color="#fff7b2" data-label="Yellow color" tabindex="0"></div>
      <div class="color-option" style="background-color: #d5fdd5;" data-color="#d5fdd5" data-label="Green color" tabindex="0"></div>
      <div class="color-option" style="background-color: #d5e9ff;" data-color="#d5e9ff" data-label="Blue color" tabindex="0"></div>
      <div class="color-option" style="background-color: #ffe2b2;" data-color="#ffe2b2" data-label="Orange color" tabindex="0"></div>
    </div>
  </div>
</div>


<script>
// ‚úÖ Volledige JS met localStorage voor speechRate, themeToggle, menuPositionToggle en annotatiesysteem

const panel = document.getElementById('annotationsPanel');
const popup = document.getElementById('annotationPopup');
const input = document.getElementById('annotationInput');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const colorPicker = document.getElementById('colorPicker');
const themeToggle = document.getElementById('themeToggle');
const positionToggle = document.getElementById('menuPositionToggle');
const slider = document.getElementById('speedSlider');
const speedValueText = document.getElementById('speedValue');
const volumeSlider = document.getElementById('volumeSlider');
const volumeValueText = document.getElementById('volumeValue');

let currentSpan = null;
let currentNote = "";
let annotationElements = [];
let inAnnotationMode = false;
let currentAnnotationIndex = 0;
let popupOpen = false;
let currentUtterance = null;
let speechRate = 0.9;
let speechVolume = 1.0;
let rateDebounceTimeout = null;
let volumeDebounceTimeout = null;


// ‚úÖ Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') document.body.classList.add('light');

// ‚úÖ Load saved menu position
const savedPosition = localStorage.getItem('menuPosition');
if (savedPosition === 'right') document.body.classList.add('menu-right');

// ‚úÖ Load saved speechRate
const storedRate = localStorage.getItem('speechRate');
if (storedRate) {
  speechRate = parseFloat(storedRate);
  slider.value = speechRate;
  speedValueText.textContent = `Current: ${speechRate.toFixed(1)}x`;
  slider.setAttribute('aria-valuenow', speechRate.toFixed(1));
  slider.setAttribute('aria-valuetext', `Speed: ${speechRate.toFixed(1)}`);
}

function speakText(text) {
  if (currentUtterance) {
    window.speechSynthesis.cancel();
    currentUtterance = null;
  }

  setTimeout(() => {
    currentUtterance = new SpeechSynthesisUtterance(text);
    currentUtterance.lang = 'en-GB';
    currentUtterance.rate = speechRate;
    currentUtterance.volume = speechVolume;
    currentUtterance.onend = () => currentUtterance = null;
    window.speechSynthesis.speak(currentUtterance);
  }, 100);
}


function stopSpeaking() {
  window.speechSynthesis.cancel();
  currentUtterance = null;
}

function announceRate() {
  const rate = speechRate.toFixed(1).replace('.', ' point ');
  const message = `Speed: ${rate}`;
  const rateUtterance = new SpeechSynthesisUtterance(message);
  rateUtterance.lang = 'en-GB';
  rateUtterance.rate = speechRate;
  window.speechSynthesis.speak(rateUtterance);
}

if (slider && speedValueText) {
    slider.addEventListener('input', () => {
  speechRate = parseFloat(slider.value);
  localStorage.setItem('speechRate', speechRate.toFixed(1));
  slider.setAttribute('aria-valuenow', speechRate.toFixed(1));
  slider.setAttribute('aria-valuetext', `Speed: ${speechRate.toFixed(1)}`);
  speedValueText.textContent = `Current: ${speechRate.toFixed(1)}x`;

  clearTimeout(rateDebounceTimeout);
  rateDebounceTimeout = setTimeout(() => {
    const feedback = new SpeechSynthesisUtterance(`Speed: ${speechRate.toFixed(1)}`);
    feedback.lang = 'en-GB';
    feedback.rate = speechRate;
    feedback.volume = speechVolume;
    window.speechSynthesis.speak(feedback);
  }, 300); // wacht 300ms na laatste input
});
}

themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('light');
  const mode = document.body.classList.contains('light') ? 'Light modus' : 'Dark modus';
  localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  speakText(`${mode} activated`);
});

positionToggle.addEventListener('click', () => {
  document.body.classList.toggle('menu-right');
  const pos = document.body.classList.contains('menu-right') ? 'Right' : 'Left';
  localStorage.setItem('menuPosition', document.body.classList.contains('menu-right') ? 'right' : 'left');
  speakText(`Annotation menu location to ${pos}`);
});

// ‚úÖ Annotatiesysteem
function closePopup() {
  popup.style.display = 'none';
  popupOpen = false;
  input.value = '';
  input.style.display = 'block';
  saveBtn.style.display = 'inline-block';
  colorPicker.style.display = 'none';
  cancelBtn.style.display = 'inline-block';
  currentNote = '';
  currentSpan = null;
}

function selectColor(option) {
  const color = option.getAttribute('data-color');
  if (currentSpan && currentNote) {
    const id = currentSpan.id;
    localStorage.setItem(`note-${id}`, currentNote);
    localStorage.setItem(`color-${id}`, color);
    currentSpan.classList.add('annotated');
    currentSpan.style.backgroundColor = color;
    closePopup();
    speakText("Annotation saved");
    updateAnnotationsPanel();
  }
}

function updateAnnotationsPanel() {
  panel.innerHTML = '<h2>Annotaties</h2>';
  annotationElements = [];

  document.querySelectorAll('.text-content span').forEach(span => {
    const note = localStorage.getItem(`note-${span.id}`);
    const color = localStorage.getItem(`color-${span.id}`);
    span.classList.remove('annotated');
    span.style.backgroundColor = '';

    if (note) {
      span.classList.add('annotated');
      if (color) span.style.backgroundColor = color;

      const item = document.createElement('div');
        item.className = 'annotation-item';
        item.dataset.ref = span.id; // ‚úÖ koppeling aan juiste span

      item.dataset.ref = span.id; // ‚úÖ koppeling aan de juiste span

      item.setAttribute('tabindex', inAnnotationMode ? '0' : '-1');
      if (color) item.style.backgroundColor = color;

      item.addEventListener('focus', () => speakText(note));
      item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
        e.preventDefault();
        currentSpan = span;
        const savedNote = localStorage.getItem(`note-${span.id}`) || '';
        const savedColor = localStorage.getItem(`color-${span.id}`) || '';

        // Open bewerk-popup
        input.value = savedNote;
        popup.style.display = 'block';
        popupOpen = true;
        input.focus();
        speakText("Annotation editing");

        // Focus trap activeren
        const focusables = [input, saveBtn, cancelBtn];
        let trapIndex = 0;

        popup.addEventListener('keydown', function focusTrap(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            if (e.shiftKey) {
            trapIndex = (trapIndex - 1 + focusables.length) % focusables.length;
            } else {
            trapIndex = (trapIndex + 1) % focusables.length;
            }
            focusables[trapIndex].focus();
        }
        });


        // Toon opnieuw kleurkiezer (na opslaan)
        input.style.display = 'block';
        saveBtn.style.display = 'inline-block';
        colorPicker.style.display = 'none';

        // Optioneel: selecteer de kleurvisueel ook alvast
        const colorOptions = document.querySelectorAll('.color-option');
        colorOptions.forEach(option => {
            if (option.getAttribute('data-color') === savedColor) {
            option.focus(); // of: markeer visueel
            }
        });
        }

        if (e.key === 'Shift' && !e.repeat) {
    e.preventDefault();
    const targetSpan = document.getElementById(span.id);
    if (targetSpan) {
      targetSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
      targetSpan.focus();
      speakText("Jumped to annotation in text");
    }
  }


        if (e.key.toLowerCase() === 'x') {
          // ‚úÖ Confirm delete with speech
          const confirmDelete = confirm("Are you sure you want to delete this annotation?");
          if (confirmDelete) {
            localStorage.removeItem(`note-${span.id}`);
            localStorage.removeItem(`color-${span.id}`);
            span.classList.remove('annotated');
            span.style.backgroundColor = '';
            speakText("Annotation deleted");
            updateAnnotationsPanel();
          }
        }
      });

      const text = document.createElement('div');
      text.textContent = note;
      text.addEventListener('click', () => {
        document.getElementById(span.id).scrollIntoView({ behavior: 'smooth', block: 'center' });
        speakText("Annotation opened");
        alert(note);
      });

      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn';
      delBtn.textContent = '';
      delBtn.setAttribute('tabindex', inAnnotationMode ? '0' : '-1');
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // ‚úÖ Confirm delete with speech
        const confirmDelete = confirm("Are you sure you want to delete this annotation?");
        if (confirmDelete) {
          localStorage.removeItem(`note-${span.id}`);
          localStorage.removeItem(`color-${span.id}`);
          span.classList.remove('annotated');
          span.style.backgroundColor = '';
          speakText("Annotatie deleted");
          updateAnnotationsPanel();
        }
      });

      item.appendChild(text);
      item.appendChild(delBtn);
      panel.appendChild(item);
      annotationElements.push(item);
    }
  });
}

// ‚úÖ Event listeners op tekst-spans

document.querySelectorAll('.text-content span').forEach(span => {
  span.setAttribute('tabindex', '0');

  span.addEventListener('focus', () => speakText(span.textContent));
  span.addEventListener('blur', stopSpeaking);
  span.addEventListener('click', () => speakText(span.textContent));

  document.addEventListener('click', (e) => {
    const insideText = e.target.closest('.text-content span');
    if (!insideText) stopSpeaking();
  });

span.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    currentSpan = span;

    // üëá Zorg dat tekstvak helemaal leeg is
    input.value = '';
    input.innerHTML = '';
    input.textContent = '';

    popup.style.display = 'block';
    popupOpen = true;

    // üßº Leeg input √©n focus erop
    input.value = '';
    input.innerHTML = '';
    input.textContent = '';
    input.focus();

    // üéØ Focus trap
    const focusables = [input, saveBtn, cancelBtn];
    let trapIndex = 0;

    popup.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
        e.preventDefault();
        if (e.shiftKey) {
        trapIndex = (trapIndex - 1 + focusables.length) % focusables.length;
        } else {
        trapIndex = (trapIndex + 1) % focusables.length;
        }
        focusables[trapIndex].focus();
    }
    });

    speakText("Add annotation");

    // Cursor helemaal aan het begin plaatsen
    setTimeout(() => {
      input.selectionStart = 0;
      input.selectionEnd = 0;
    }, 0);

    colorPicker.style.display = 'none';

    setTimeout(() => {
      const focusables = popup.querySelectorAll('textarea, button, .color-option');
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      popup.addEventListener('keydown', function (e) {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      });
    });
  }
});
    
    });

    function trapColorFocus(e) {
  const colorOptions = popup.querySelectorAll('.color-option');
  const first = colorOptions[0];
  const last = colorOptions[colorOptions.length - 1];

  if (e.key === 'Tab') {
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }
}

saveBtn.addEventListener('click', () => {
  if (input.value.trim() !== "") {
    currentNote = input.value.trim();
    input.style.display = 'none';
    saveBtn.style.display = 'none';
    colorPicker.style.display = 'block';
    cancelBtn.style.display = 'none';

    speakText("Choose a color for the annotation");

    setTimeout(() => {
      const colorOptions = popup.querySelectorAll('.color-option');
      if (colorOptions.length === 0) return;

      let trapIndex = 0;
      colorOptions.forEach((opt, i) => {
        if (opt === document.activeElement) trapIndex = i;
      });

      colorOptions[0].focus(); // focus op de eerste kleur

      popup.addEventListener('keydown', trapColorKeys);

      function trapColorKeys(e) {
        const active = document.activeElement;
        const isColorFocused = Array.from(colorOptions).includes(active);

        if (e.key === 'Tab') {
          e.preventDefault();
          if (e.shiftKey) {
            trapIndex = (trapIndex - 1 + colorOptions.length) % colorOptions.length;
          } else {
            trapIndex = (trapIndex + 1) % colorOptions.length;
          }
          colorOptions[trapIndex].focus();
        }
      }
    }, 100);
    speakText("Pick a color for your annotation");

  }
});





cancelBtn.addEventListener('click', () => {
  closePopup();
  speakText("Annotation canceled");
  
});

// üéß Spreek knoptekst uit bij focus (zowel voor toevoegen als aanpassen)
saveBtn.addEventListener('focus', () => {
  speakText("Save");
});

cancelBtn.addEventListener('focus', () => {
  speakText("Cancel");
});


const colorOptions = document.querySelectorAll('.color-option');
colorOptions.forEach((option, index) => {
  option.addEventListener('click', () => selectColor(option));
  option.addEventListener('focus', () => speakText(option.getAttribute('data-label') || 'Kleur'));
  option.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      const next = colorOptions[index + 1] || colorOptions[0];
      next.focus();
    }
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      const prev = colorOptions[index - 1] || colorOptions[colorOptions.length - 1];
      prev.focus();
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      selectColor(option);
    }
  });
});

input.addEventListener('keydown', (e) => {
  if (e.key === "Shift" && e.shiftKey && input.value.trim() !== "") speakText(input.value);
  if (e.key === 'Escape') {
    closePopup();
    speakText("Annotation canceled");
  }
});

document.addEventListener('keydown', (e) => {
  if (popupOpen) return;

  const activeEl = document.activeElement;
  if (settingsOpen) return;

  // üîÅ Van span ‚Üí bijpassende annotatie springen met 'a'
  if (
    e.key.toLowerCase() === 'a' &&
    activeEl &&
    activeEl.classList.contains('annotated') &&
    activeEl.id
  ) {
    e.preventDefault();
    const spanId = activeEl.id;

    console.log(`üîç Looking for annotation linked to span: ${spanId}`);

    const matchingItem = Array.from(document.querySelectorAll('.annotation-item')).find(item => {
      return item.dataset.ref === spanId;
    });

    if (matchingItem) {
      matchingItem.focus();
      speakText("Bijbehorende annotatie geopend");
      console.log("‚úÖ Match gevonden:", matchingItem);
    } else {
      console.warn("‚ùå Geen bijpassende annotatie gevonden voor spanId:", spanId);
      speakText("Geen annotatie gevonden voor dit stuk tekst");
    }
    return; // Stop hier, de rest van de annotatie-modus skippen
  }

  // üîÅ Normale annotatie-navigatie met spatie of 'a'
  if (e.key === ' ' || e.key.toLowerCase() === 'a') {
    e.preventDefault();
    if (!inAnnotationMode) {
      inAnnotationMode = true;
      updateAnnotationsPanel();
      currentAnnotationIndex = 0;
      focusCurrentAnnotation();
    } else {
      currentAnnotationIndex++;
      if (currentAnnotationIndex >= annotationElements.length) currentAnnotationIndex = 0;
      focusCurrentAnnotation();
    }
  }

  if ((e.key === 'Escape' || e.key === 'Tab') && inAnnotationMode) {
    inAnnotationMode = false;
    updateAnnotationsPanel();
    currentAnnotationIndex = 0;
  }
});


function focusCurrentAnnotation() {
  if (annotationElements.length > 0) {
    annotationElements[currentAnnotationIndex].focus();
  }
}

const storedVolume = localStorage.getItem('speechVolume');
if (storedVolume) {
  speechVolume = parseFloat(storedVolume);
  volumeSlider.value = speechVolume;
  volumeValueText.textContent = `Current: ${speechVolume.toFixed(1)}`;
}

if (volumeSlider && volumeValueText) {
    volumeSlider.addEventListener('input', () => {
  speechVolume = parseFloat(volumeSlider.value);
  localStorage.setItem('speechVolume', speechVolume.toFixed(1));
  volumeValueText.textContent = `Current: ${speechVolume.toFixed(1)}`;

  clearTimeout(volumeDebounceTimeout);
  volumeDebounceTimeout = setTimeout(() => {
    const feedback = new SpeechSynthesisUtterance(`Volume: ${speechVolume.toFixed(1)}`);
    feedback.lang = 'en-GB';
    feedback.rate = speechRate;
    feedback.volume = speechVolume;
    window.speechSynthesis.speak(feedback);
  }, 300); // wacht 300ms na laatste input
});
}

const settingsPanel = document.getElementById('settingsPanel');
let settingsOpen = false;

document.addEventListener('keydown', (e) => {
  // Open/Sluit instellingenmenu alleen als je NIET in de popup aan het typen bent
  const activeElement = document.activeElement;
  const isTyping = activeElement === input || popupOpen;

  if (e.key.toLowerCase() === 'o' && !isTyping) {
    e.preventDefault(); // voorkom onbedoelde focus
    settingsOpen = !settingsOpen;
    settingsPanel.style.display = settingsOpen ? 'block' : 'none';

    if (settingsOpen) {
      const first = settingsPanel.querySelector('button, input');
      first && first.focus();
      speakText("Settings menu opened");
    } else {
      speakText("Settings menu closed");
    }
  }
});


// ‚úÖ Focus trap binnen het instellingenmenu
settingsPanel.addEventListener('keydown', function (e) {
  if (!settingsOpen) return;
  const focusable = settingsPanel.querySelectorAll('button, input');
  const first = focusable[0];
  const last = focusable[focusable.length - 1];

  if (e.key === 'Tab') {
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }
});

const settingsFocusable = settingsPanel.querySelectorAll('button, input[type="range"]');

settingsFocusable.forEach(element => {
  element.addEventListener('focus', () => {
    let label = element.getAttribute('aria-label') || element.innerText || element.id;

    // Voor sliders kun je ook de current value zeggen:
    if (element.type === 'range') {
      label += `, current value ${parseFloat(element.value).toFixed(1)}`;
    }

    speakText(label);
  });
});

const textContainer = document.querySelector('.text-content');

// üî† Font size
const fontSizeSlider = document.getElementById('fontSizeSlider');
const fontSizeValue = document.getElementById('fontSizeValue');
fontSizeSlider.addEventListener('input', () => {
  const size = `${fontSizeSlider.value}px`;
  textContainer.style.fontSize = size;
  fontSizeValue.textContent = `Current: ${size}`;
  speakText(`Font size ${fontSizeSlider.value} pixels`);
});

// üÖ±Ô∏è Font weight
const fontWeightSlider = document.getElementById('fontWeightSlider');
const fontWeightValue = document.getElementById('fontWeightValue');
fontWeightSlider.addEventListener('input', () => {
  textContainer.style.fontWeight = fontWeightSlider.value;
  fontWeightValue.textContent = `Current: ${fontWeightSlider.value}`;
  speakText(`Font weight ${fontWeightSlider.value}`);
});

// üìè Line height
const lineHeightSlider = document.getElementById('lineHeightSlider');
const lineHeightValue = document.getElementById('lineHeightValue');
lineHeightSlider.addEventListener('input', () => {
  textContainer.style.lineHeight = lineHeightSlider.value;
  lineHeightValue.textContent = `Current: ${lineHeightSlider.value}`;
  speakText(`Line height ${lineHeightSlider.value}`);
});

// üî° Letter spacing
const letterSpacingSlider = document.getElementById('letterSpacingSlider');
const letterSpacingValue = document.getElementById('letterSpacingValue');
letterSpacingSlider.addEventListener('input', () => {
  textContainer.style.letterSpacing = `${letterSpacingSlider.value}px`;
  letterSpacingValue.textContent = `Current: ${letterSpacingSlider.value}`;
  speakText(`Letter spacing ${letterSpacingSlider.value}`);
});




window.addEventListener('load', updateAnnotationsPanel);


</script>

</body>
</html>

